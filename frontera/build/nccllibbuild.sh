#!/bin/bash

# ---[ Script Setup ]---

set -e


# ---[ Set Up cuda/nccl/nccl-test/mpi ]---

module load impi/19.0.5
module load cuda/11.3
module load intel  

export CUDA_HOME=/opt/apps/cuda/11.3
# export MPI_HOME=/scratch1/projects/compilers/intel18u5/compilers_and_libraries_2018.6.288/linux/mpi/intel64
export MPI_HOME=/opt/intel/compilers_and_libraries_2019.5.281/linux/mpi/intel64

export NVCC_GENCODE="-gencode=arch=compute_75,code=sm_75"

# Update to include the correct path for MPI library paths
export LD_LIBRARY_PATH=${MPI_HOME}/lib:$LD_LIBRARY_PATH
export PATH=${MPI_HOME}/bin:$PATH
export C_INCLUDE_PATH=${MPI_HOME}/include:$C_INCLUDE_PATH

export PATH=$CUDA_HOME/bin:$PATH
export C_INCLUDE_PATH=$CUDA_HOME/include:$C_INCLUDE_PATH
export CPLUS_INCLUDE_PATH=$CUDA_HOME/include:$CPLUS_INCLUDE_PATH
export LD_LIBRARY_PATH=$CUDA_HOME/lib64:$LD_LIBRARY_PATH
export CUDACXX=$CUDA_HOME/bin/nvcc
export CUDNN_LIBRARY=$CUDA_HOME/lib64
export CUDNN_INCLUDE_DIR=$CUDA_HOME/include


# ---[ Set Up nccl ]---
export NCCL_HOME="/home1/09168/ldai1/ccl-build/nccl/build"

export LD_LIBRARY_PATH="${NCCL_HOME}/lib:$LD_LIBRARY_PATH"


# for the shared library generated by myself

export libnccl_HOME="/home1/09168/ldai1/ccl-build/netgauge_nccl/libnccl"

export LD_LIBRARY_PATH="${libnccl_HOME}:$LD_LIBRARY_PATH"


echo "########## ENVIRONMENT ########"
echo "NCCL_LOCATION=${NCCL_HOME}"
# echo "NCCL_TEST_LOCATION=${NCCL_TEST_HOME}"
# echo " ### nccl based nccl-test ###"
# echo " ### how to check ###"
# ldd /home/ldai8/NCCL/deps-nccl/nccl-tests/build/all_reduce_perf
# echo " ### check end ###"
echo ""

# export NCCL_DEBUG=INFO
# export NCCL_ALGO=Tree
# export NCCL_PROTO=LL128

pushd ${libnccl_HOME}

nvcc -shared -o libMyNcclCode.so MyNcclCode.cu -I/${libnccl_HOME}  -I/${NCCL_HOME}/include -L/${NCCL_HOME}/lib -lnccl -L/${CUDA_HOME}/lib64 -lcudart -Xcompiler -fPIC

# nvcc -I/opt/apps/mpi/mpich-3.4.2_nvidiahpc-21.9-0/include -I/home/ldai8/nccl-learning/p2p ncclp2p.cc -o ncclp2p -L/home/ldai8/NCCL/deps-nccl/nccl/build/lib -lnccl -L/opt/apps/mpi/mpich-3.4.2_nvidiahpc-21.9-0/lib -lmpi

# nvcc -I/opt/apps/mpi/mpich-3.4.2_nvidiahpc-21.9-0/include -I/home/ldai8/nccl-learning/p2p ncclp2p_shared.cc -o ncclp2p -L/home/ldai8/NCCL/deps-nccl/nccl/build/lib -lnccl -L/opt/apps/mpi/mpich-3.4.2_nvidiahpc-21.9-0/lib -lmpi -L/home/ldai8/nccl-learning/p2p -lmynccl_code




popd